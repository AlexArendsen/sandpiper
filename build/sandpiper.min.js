function showMessage(a,b){Materialize.toast(a,b||4e3)}var app=angular.module("sandpiper",[]);$(document).ready(function(){$(".button-collapse").sideNav(),$("body").on("click",".modal-trigger:not(.modal-trigger-initialized)",function(){$(".modal-trigger:not(.modal-trigger-initialized)").leanModal().addClass("modal-trigger-initialized"),$(this).trigger("click")})}),app.controller("DashCtrl",["$scope","files",function(a,b){a.ready=!1,b.dump(function(b){a.results=b},function(b){a.error=b},function(){a.ready=!0})}]),app.factory("files",["$http","fileUtils",function(a,b){return{dump:function(c,d,e){d=d||function(){},e=e||function(){},a.get("file.dump.php").success(function(a,f){if(a.success){for(idx in a.payload)inf=b.getPathInfo(a.payload[idx].file,"UNKOWN"),a.payload[idx].type=inf.extension.toUpperCase(),a.payload[idx].image=inf.image;c(a.payload),e()}else d(a.error),e()}).error(function(a,b){d(a.error),e()})},getFile:function(b,c,d){d=d||function(){},a.get("file.get.php?fileId="+b).success(function(a,b){a.success?c(a.fileInfo):d(a.error)}).error(function(a,b){d(a.error)})}}}]),app.controller("EditorCtrl",["$scope","files",function(a,b){a.editor={title:"Loading...",submitlabel:"...",continuelabel:"..."},a.file={},(id=$("#file-id").val())?(a.file.isNew=!1,a.file.action="update",$("#file-action").val("update"),b.getFile(id,function(b){a.file=b,a.file.tags=a.file.tags.join(","),a.editor.title="Update "+a.file.title,a.editor.submitlabel="Update",a.editor.continuelabel="Update and Add Another"})):(a.file.isNew=!0,a.file.action="insert",$("#file-action").val("insert"),a.editor.title="Add New File",a.editor.submitlabel="Create",a.editor.continuelabel="Create and Add Another"),a.onFileChange=function(){a.file.title||(a.file.title=a.file.path)}}]),app.factory("fileUtils",[function(){var a={getExtension:function(a,b){return a&&(mat=a.match(/\.(.+)$/))&&mat[1]?mat[1]:b},getPathInfo:function(b,c){return extension=a.getExtension(b,c).toLowerCase(),image="static/img/filetypes/_blank.png",-1!=extension.search(/png|jpg|jpeg|gif|bmp/)?image="authorize.php?file="+b:-1!=["aac","aiff","ai","avi","bmp","c","cpp","css","dat","def","dmg","doc","dotx","dwg","dxf","eps","exe","flv","gif","h","hpp","html","ics","iso","java","jpg","js","key","less","mid","mp3","mp4","mpg","odf","ods","odt","otp","ots","ott","pdf","php","png","ppt","psd","py","qt","rar","rb","rtf","sass","scss","sql","tga","tgz","tiff","txt","wav","xls","xlsx","xml","yml","zip"].indexOf(extension)&&(image="static/img/filetypes/"+extension+".png"),{extension:extension,image:image}}};return a}]),app.controller("UsersCtrl",["$scope","users",function(a,b){a.users=[],b.dump(function(b){a.users=b},function(a){showMessage(a)}),a.userDelete=function(c){confirm("Are you sure you want to delete this user? All of their files will be removed")&&b["delete"](c.id,function(){a.users.splice(a.users.indexOf(c),1),Materialize.toast("User deleted successfully",4e3)},function(a){Materialize.toast(a,4e3)})},a.userSubmit=function(c){(isNewUser=!c.id)?b.create(c,function(b){a.users.push({id:b.userData.id,username:b.userData.username,isAdmin:!!b.userData.isAdmin}),$("#modal-user-form").closeModal(),Materialize.toast("User created successfully!",4e3),a.$apply()},function(a){Materialize.toast(a,4e3)}):(b.update(c,function(b){-1!=(idx=a._userIndex(b.userData.id))?a.users[idx]=b.userData:console.error("Failed to find user with ID "+b.userData.id),$("#modal-user-form").closeModal(),Materialize.toast("User updated successfully!",4e3),a.$apply()}),function(a){Materialize.toast(a,4e3)})},a.clearUser=function(){a.editor={}},a.userSelect=function(b){a.editor={username:b.username,isAdmin:!!b.isAdmin,id:b.id}},a._userIndex=function(b){for(idx in a.users)if(a.users[idx].id==b)return idx;return-1}}]),app.factory("users",["$http",function(a){return{dump:function(b,c){c=c||function(){},a.get("user.dump.php").success(function(a,d){a.success?b(a.payload):c(a.error)}).error(function(a,b){c(a.error)})},"delete":function(b,c,d){d=d||function(){},a.get("user.delete.php?i="+b).success(function(a,b){a.success?c():d(a.error)}).error(function(a,b){d(a.error)})},create:function(a,b,c){c=c||function(){};for(k in l=[["username","username"],["password","password"],["passwordConfirm","password confirmation"]])if(!(a[l[k][0]]=$.trim(a[l[k][0]])))return c("Please provide "+l[k][1]);return a.password!=a.passwordConfirm?c("Passwords do not match"):(bc=new bCrypt,void bc.hashpw(a.password,bc.gensalt(9),function(d){function e(a){try{return JSON.parse(a)}catch(b){return a}}arguments={username:a.username,password:d,isAdmin:!!a.isAdmin},$.ajax({url:"user.create.php",type:"POST",data:arguments,success:function(a){data=e(a),data.success?b(data):c(data.error)},error:function(a){data=e(a.responseText),c(data.error)}})}))},update:function(a,b,c){function d(a){try{return JSON.parse(a)}catch(b){return a}}function e(a){$.ajax({url:"user.update.php",type:"POST",data:a,success:function(a){data=d(a),data.success?b(data):c(data.error)},error:function(a){data=d(a.responseText),c(data.error)}})}if(c=c||function(){},a.password){if(a.password!=a.passwordConfirm)return c("Passwords do not match");bc=new bCrypt,bc.hashpw(a.password,bc.gensalt(9),function(b){e({username:a.username,password:b,isAdmin:!!a.isAdmin,id:a.id})})}else e({username:a.username||"",isAdmin:!!a.isAdmin,id:a.id})}}}]);